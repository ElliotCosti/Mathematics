/*
Construction of Spin_8^-(q).
*/

// Two visible submodules generated by V.i, i in {1,4,6,7,10,11,13,16} and {2,3,5,8,9,12,14,15}.
// x23o only required when q=3.
// x1, x7, x8 to the same named elements in Spin_8^+(q) construction.
// x4 vaguely correponds to element named x4 in Spin_8^+(q) construction, but has order q+1 instead of q-1.
// x23 corresponds to x2*x3^-1 in Spin_8^+(q) construction, and x23o is also in <x2,x3>.
// x26 and x46 correspond to the elements x2^x6 and x4^x6 in Spin_8^+(q) construction.

Spin8Minus := function(q)
F<w>:=GF(q^2);
b:=PrimitiveElement(F);bb:=1/b;
c:=b^(q-1);cc:=1/c;
a:=b^(q+1);aa:=1/a;

G:=MatrixGroup<16,F|[
0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0]
,[
1,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,-1,0,0,0,0,0,0,0,0,
0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,1,0,0,-1,0,0,0,0,
0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,-1,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
,[
1,0,0,-c^q,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,c,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,-c^q,0,0,0,0,0,0,0,0,
0,0,0,0,0,1,c,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,1,0,0,-c^q,0,0,0,0,
0,0,0,0,0,0,0,0,0,1,c,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,-c^q,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,c,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
,[
1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
,[
c,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,c^-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,c,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,c^-1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,c,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,c^-1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,c,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,c^-1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,c,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,c^-1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,c,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,c^-1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,c,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,c^-1,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,c,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c^-1]
,[
a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,a^-1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,a^-1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,a,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,a,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,a^-1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,a^-1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,a,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,a,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,a^-1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,a^-1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,a,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,a,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,a^-1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,a^-1]
,[
1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1]
>;

x8:=GL(16,F)![
0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,-1,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,-1,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0];
return G, x8;
end function;

ChangeOfBasisMatrix := function(G);

   F := BaseRing (G);
   d := Dimension(G);
   M := KMatrixSpace(F, d, d); 
   b := Basis(M);
   Z := IntegerRing();
   G := SL(d, F);

   CB := ZeroMatrix(F, d, d);
   for i in [1..(d div 2)] do
      CB := CB + b[(i-1)*d + 2*i - 1];
   end for;
   for i in [1..(d div 2)] do
      CB := CB + b[(d div 2)*d + i*d - 2*i + 2];
   end for;
   return G!CB;

end function;

O8M := function(q)
  SetSeed(1);
  M := GModule(Spin8Minus(q));
  M1:=sub<M|M.1>;
  M2:=sub<M|M.9>;
  T:=TensorProduct(M1,M2);
  MM := [c: c in Constituents(T) | Dimension(c) eq 8][1];
  A := ActionGroup(MM);
  iss, G := IsOverSmallerField(A);
  return G^(TransformForm(G));
end function;

